function calculate() {
    let totalQuantity = Number(document.getElementById('totalQuantity').value);
    let boxQuantity = Number(document.getElementById('boxQuantity').value);
    let palleteBoxes = Number(document.getElementById('palleteBoxes').value);

    const results = document.getElementById('results');
    results.innerHTML = '';

    // Валідація: перевіряємо, щоб хоча б два поля були заповнені
    const filledFields = [totalQuantity, boxQuantity, palleteBoxes].filter(value => value > 0).length;
    if (filledFields < 2) {
        results.innerHTML = '<p class="error">Будь ласка, заповніть принаймні два поля.</p>';
        return;
    }

    // Логіка розрахунку, якщо одне з полів пусте
    if (isNaN(totalQuantity)) totalQuantity = boxQuantity * palleteBoxes;
    else if (isNaN(boxQuantity)) boxQuantity = Math.ceil(totalQuantity / palleteBoxes);
    else if (isNaN(palleteBoxes)) palleteBoxes = Math.ceil(totalQuantity / boxQuantity);

    // Основні розрахунки
    const totalBoxes = Math.ceil(totalQuantity / boxQuantity);
    const fullPallets = Math.floor(totalBoxes / palleteBoxes);
    const remainingBoxes = totalBoxes % palleteBoxes;
    const lastBoxQuantity = totalQuantity % boxQuantity;
    const quantityPerPallet = palleteBoxes * boxQuantity;

    // Заміняємо NaN і Infinity на прочерк
    const safeValue = (value) => (isNaN(value) || !isFinite(value)) ? '—' : value;

    // Оновлений формат виводу з пробілами та об'єднанням повних ящиків
    let resultString = '';
    if (fullPallets > 0) {
        resultString += `${safeValue(fullPallets)}п`;
        if (remainingBoxes > 0) resultString += ' + ';
    }
    if (remainingBoxes > 0) {
        if (lastBoxQuantity === 0) {
            // Якщо останній ящик повний, просто додаємо його до загальної кількості ящиків
            resultString += `${safeValue(remainingBoxes)}ящ`;
        } else {
            // Якщо останній ящик неповний, вказуємо окремо
            if (remainingBoxes > 1) {
                resultString += `${safeValue(remainingBoxes - 1)}ящ + `;
            }
            resultString += `1ящ - ${safeValue(lastBoxQuantity)} шт`;
        }
    }
    if (resultString === '') resultString = '0';

    const resultHTML = `
        <h3>Результат:</h3>
        <p><strong>Розрахунок:</strong> ${resultString}</p>
        <p><strong>Кількість продукції в палеті:</strong> ${safeValue(quantityPerPallet)} шт</p>
        <p><strong>Усього ящиків:</strong> ${safeValue(totalBoxes)} шт</p>
        <p><strong>Тираж:</strong> ${safeValue(totalQuantity)}, <strong>Кількість у ящику:</strong> ${safeValue(boxQuantity)}, <strong>Ящиків на палеті:</strong> ${safeValue(palleteBoxes)}</p>
        <div id="wishesOfTheDay">
            ${generateWishesOfTheDay()}
        </div>
    `;

    results.innerHTML = resultHTML;

    // Додавання в історію
    history.unshift({ totalQuantity, boxQuantity, palleteBoxes, results: resultHTML });
    if (history.length > 10) history.pop();

    // Збереження історії в localStorage
    localStorage.setItem('calculationHistory', JSON.stringify(history));

    updateHistoryDisplay();
}
